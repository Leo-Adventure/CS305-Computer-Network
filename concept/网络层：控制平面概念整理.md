## 网络层：控制平面概念整理

### 概述

- 计算转发表和流表方法：每路由器控制（OSPF、BGP）（与其他路由器的组件进行通信）以及 逻辑集中式控制（由逻辑集中式控制器计算并分发转发表）
- 控制代理（CA） 功能：与控制器通信并且按控制器命令行事，不能直接相互交互也不能主动参与计算转发表（SDN）

### 路由选择算法

- 目的：从发送方到接收方的过程中确定一条通过路由器网络的好的路径（通常是最低开销）
- 分类方式：
  - 集中式路由选择算法（centralized）具有全局状态信息（链路状态（Link state）算法）
  - 分散式路由选择算法（decentralized）使用迭代、分布式的方式计算出最低开销路径，没有完整信息，距离向量算法（DV算法）
- 第二种分类方式：
  - 静态路由选择算法（static）路由随时间变化非常缓慢，通常是人工进行调整
  - 动态路由选择算法（dynamic）随着网络流量负载或拓扑发生变化而改变路由选择路径

#### 链路状态路由选择算法（LS 算法）

通过让每个节点向网络中所有其他节点广播链路状态分组来完成全局信息输入，经常由链路状态广播算法来完成

Dijkstra 算法

#### 距离向量路由选择算法（DV 算法）

分布式：每个节点都要从一个或者多个直接相连邻居接收某些信息

迭代：过程持续到邻居之间没有更多信息要交换为止

异步：不要求所有节点相互之间步伐一致地操作

过程：当节点 x 发现它的直接相连的链路开销变化或从某个邻居接收到一个距离向量的更新时，就更新其距离向量估计值。

链路开销改变和链路故障

增加毒性逆转：如果 z 通过 y 路由选择到目的地 x， 则 z 将会通告 y，它到 x 的距离是无穷大

#### 算法比较

##### 报文复杂性

LS 要求每个节点都知道网络中每条链路的开销。而DV 算法只要求在每次迭代时，在两个直接相连的邻居之间交换报文。

##### 收敛速度

DV 算法相较于 LS 算法收敛较慢，且会遇到路由选择环路以及无穷计数问题

##### 健壮性

在 LS 算法下，路由计算在某种程度上面是分离的，一个 LS 节点仅仅计算自己的转发表。

DV 算法则会想任意或者所有目的节点通告其不正确的最低开销路径。

### 因特网自治系统内部的路由选择：OSPF

在相同 AS 中的路由器都运行相同的路由选择算法并且有彼此的信息，在一个自治系统内运行的路由选择算法叫做自治系统内部路由选择协议（intra-autonomous system routing protocal）kaifan

#### 开放最短路优先（OSPF）

OSPF 是一种链路状态协议，使用洪泛链路状态信息和 Dijkstra 最低开销路径算法。

使用 OSPF 时，路由器向自治系统内所有其他路由器广播路由选择信息，而不仅仅是向其相邻路由器广播

如果链路状态变化，则路由器就会广播链路状态信息；即使没有变化，路由器也会周期性的广播链路状态。

##### 优点

- 安全：能够鉴别 OSPF 路由器之间的交换，仅有受信任的路由器能参与一个 AS 内的 OSPF 协议，因此可以防止恶意入侵者将不正确的信息注入路由表内。
- 可以选择多条相同开销的路径，无须仅仅使用单一的路径来承载所有的流量
- 对单播和多播路由选择的综合支持
- 支持在单个 AS 内部提供层次结构

### ISP 之间的路由选择：BGP

分组跨越多个 AS 进行路由时，需要自治系统间路由选择协议（intra-autonomous system routing protocol）。

因为 AS 间路由协议涉及多个 AS 之间的协调，所以 AS 通信必须运行相同的 AS 间路由选择协议，在互联网当中，所有的 AS 运行相同的 AS 间路由选择协议，成为边界网关协议（Border Gateway Protocol  **BGP**）

#### BGP 作用

在 BGP 中，分组并不是路由到一个特定的目的地址，相反是路由到 CIDR 化的前缀，其中每个前缀表示一个子网或者一个子网的集合。

- 从邻居 AS 获得前缀的可达性信息
- 确定到该前缀的“最好的”路由

#### 通告 BGP 路由信息

对于每个 AS， 每台路由器要么是一台网关路由器，要么是一台内部路由器

每条直接连接以及所有通过该连接发送的 BGP 报文成为 BGP 连接，跨越两个 AS 的 BGP 连接成为外部 BGP（eBGP），在相同 AS 中的两台路由器之间的 BGP 会话称为 内部 BGP 连接 (iBGP)

为了传播可达性信息，使用了 iBGP 和 eBGP 会话。

#### 确定最好的路由

当路由器通过 BGP 连接通告前缀时，它在前缀中包括一些 BGP 属性。用BGP术语来说，前缀以及其属性称为路由。

两个较为重要的属性是 AS-PATH 和 NEXT-HOP。AS-PATH 属性包含了通告已经通过的 AS 列表。如果一台路由器在路径列表中看到了包含它自己的 AS， 它将拒绝该通告。NEXT-HOP 是 AS-PATH 起始的路由器接口的 IP 地址，

##### 热土豆路由选择

1. 从 AS 间协议学到经多个网关可达子网
2. 使用来自 AS 内部协议的路由选择信息，以决定到达每个网关的最低开销路径的开销
3. 热土豆路由选择：选择具有最小最低开销的网关
4. 从转发表确定通往最低开销网关的接口 I，在转发表中加入表项（x, I）

##### 路由选择算法

1. 路由被指派一个本地偏好值作为属性之一
2. 从余下的路由中选择具有最短 AS-PATH 的路由
3. 从余下的路由中，使用热土豆路由选择，即选择最靠近 NEXT-HOP 的路由
4. 最后使用BGP标识选择路由